<app-navbar></app-navbar>

<div class="search-page-container" style="margin-top: 90px; position: relative; z-index: 1;">
  <!-- Hero Search Section -->
  <section class="search-hero">
    <div class="container">
      <div class="hero-content">
        <h1 class="hero-title">
          <i class="fas fa-pills"></i>
          ابحث عن دوائك
        </h1>
        <p class="hero-subtitle">اعثر على الأدوية المناسبة من أقرب الصيدليات إليك</p>
        
        <!-- Advanced Search Bar -->
        <div class="search-container">
          <div class="search-wrapper">
            <div class="search-input-group">
              <i class="fas fa-search search-icon"></i>
              <input 
                type="text" 
                [(ngModel)]="searchQuery" 
                (keyup.enter)="searchProducts()"
                (input)="onSearchInput()"
                placeholder="ابحث عن الدواء أو العنصر النشط أو الشركة المصنعة..."
                class="search-input">
              <button 
                *ngIf="searchQuery" 
                (click)="clearSearch()" 
                class="clear-btn">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <!-- Quick Category Filters -->
            <div class="quick-filters">
              <button 
                *ngFor="let cat of quickCategories" 
                (click)="selectQuickCategory(cat.value)"
                [class.active]="filters.category === cat.value"
                class="quick-filter-btn">
                <i [class]="cat.icon"></i>
                {{ cat.label }}
              </button>
            </div>
            
            <div class="search-actions">
              <button (click)="searchProducts()" class="btn btn-search">
                <i class="fas fa-search"></i>
                بحث
              </button>
              <button 
                (click)="toggleFilters()" 
                class="btn btn-filters"
                [class.active]="showFilters">
                <i class="fas fa-filter"></i>
                فلاتر
                <span class="filter-count" *ngIf="activeFiltersCount > 0">{{ activeFiltersCount }}</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Advanced Filters Panel -->
  <section class="filters-section" [class.show]="showFilters">
    <div class="container">
      <div class="filters-panel">
        <div class="filters-header">
          <h3>
            <i class="fas fa-sliders-h"></i>
            تصفية النتائج
          </h3>
          <button (click)="resetFilters()" class="reset-filters-btn">
            <i class="fas fa-undo"></i>
            إعادة تعيين
          </button>
        </div>
        
        <div class="filters-grid">
          
          <!-- Category Filter -->
          <div class="filter-group">
            <label class="filter-label">
              <i class="fas fa-tags"></i>
              الفئة
            </label>
            <select [(ngModel)]="filters.category" (change)="applyFilters()" class="filter-select">
              <option *ngFor="let category of categories" [value]="category.value">
                {{ category.label }}
              </option>
            </select>
          </div>
          
          <!-- Price Range Filter -->
          <div class="filter-group">
            <label class="filter-label">
              <i class="fas fa-money-bill-wave"></i>
              السعر (جنيه مصري)
            </label>
            <div class="price-range">
              <input 
                type="number" 
                [(ngModel)]="filters.priceRange.min" 
                (change)="applyFilters()"
                placeholder="من"
                class="price-input">
              <span class="price-separator">-</span>
              <input 
                type="number" 
                [(ngModel)]="filters.priceRange.max" 
                (change)="applyFilters()"
                placeholder="إلى"
                class="price-input">
            </div>
          </div>
          
          <!-- Seller Type Filter -->
          <div class="filter-group">
            <label class="filter-label">
              <i class="fas fa-store"></i>
              نوع البائع
            </label>
            <select [(ngModel)]="filters.sellerType" (change)="applyFilters()" class="filter-select">
              <option value="">جميع البائعين</option>
              <option value="pharmacy">صيدليات</option>
              <option value="rxclose">RxClose</option>
            </select>
          </div>
          
          <!-- Prescription Filter -->
          <div class="filter-group">
            <label class="filter-label">
              <i class="fas fa-prescription"></i>
              الروشتة
            </label>
            <div class="radio-group">
              <label class="radio-option">
                <input 
                  type="radio" 
                  name="prescription" 
                  [value]="null" 
                  [(ngModel)]="filters.prescriptionRequired"
                  (change)="applyFilters()">
                <span class="radio-text">الكل</span>
              </label>
              <label class="radio-option">
                <input 
                  type="radio" 
                  name="prescription" 
                  [value]="true" 
                  [(ngModel)]="filters.prescriptionRequired"
                  (change)="applyFilters()">
                <span class="radio-text">بروشتة</span>
              </label>
              <label class="radio-option">
                <input 
                  type="radio" 
                  name="prescription" 
                  [value]="false" 
                  [(ngModel)]="filters.prescriptionRequired"
                  (change)="applyFilters()">
                <span class="radio-text">بدون روشتة</span>
              </label>
            </div>
          </div>
          
          <!-- Availability Filter -->
          <div class="filter-group">
            <label class="filter-label">
              <i class="fas fa-boxes"></i>
              التوفر
            </label>
            <select [(ngModel)]="filters.availability" (change)="applyFilters()" class="filter-select">
              <option value="all">الكل</option>
              <option value="in-stock">متوفر</option>
              <option value="low-stock">كمية قليلة</option>
              <option value="out-of-stock">غير متوفر</option>
            </select>
          </div>
          
          <!-- Distance Filter -->
          <div class="filter-group" *ngIf="userLocation">
            <label class="filter-label">
              <i class="fas fa-map-marker-alt"></i>
              المسافة (كم)
            </label>
            <select [(ngModel)]="filters.maxDistance" (change)="applyFilters()" class="filter-select">
              <option value="">أي مسافة</option>
              <option value="1">أقل من 1 كم</option>
              <option value="3">أقل من 3 كم</option>
              <option value="5">أقل من 5 كم</option>
              <option value="10">أقل من 10 كم</option>
            </select>
          </div>
          
        </div>
      </div>
    </div>
  </section>

  <!-- Search Results Section -->
  <section class="results-section">
    <div class="container">
      
      <!-- Results Header -->
      <div class="results-header">
        <div class="results-info">
          <h2 class="results-title">
            <span *ngIf="searchQuery">نتائج البحث عن "{{ searchQuery }}"</span>
            <span *ngIf="!searchQuery">جميع المنتجات</span>
          </h2>
          <p class="results-count" *ngIf="!loading">
            تم العثور على {{ searchResults.length }} منتج
            <span *ngIf="nearbyPharmacies.length > 0">
              من {{ nearbyPharmacies.length }} صيدلية
            </span>
          </p>
        </div>
        
        <!-- Sort Options -->
        <div class="sort-container">
          <label class="sort-label">ترتيب حسب:</label>
          <select [(ngModel)]="filters.sortBy" (change)="applyFilters()" class="sort-select">
            <option *ngFor="let option of sortOptions" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
          
          <!-- View Toggle -->
          <div class="view-toggle">
            <button 
              (click)="viewMode = 'grid'" 
              [class.active]="viewMode === 'grid'"
              class="view-btn">
              <i class="fas fa-th"></i>
            </button>
            <button 
              (click)="viewMode = 'list'" 
              [class.active]="viewMode === 'list'"
              class="view-btn">
              <i class="fas fa-list"></i>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Loading State -->
      <div *ngIf="loading" class="loading-state">
        <div class="loading-spinner">
          <i class="fas fa-spinner fa-spin"></i>
          <p>جاري البحث عن المنتجات...</p>
        </div>
      </div>
      
      <!-- Error State -->
      <div *ngIf="error" class="error-state">
        <div class="error-content">
          <i class="fas fa-exclamation-triangle"></i>
          <h3>حدث خطأ في البحث</h3>
          <p>{{ error }}</p>
          <button (click)="searchProducts()" class="btn btn-primary">إعادة المحاولة</button>
        </div>
      </div>
      
      <!-- No Results State -->
      <div *ngIf="noResults && !loading && !error" class="no-results-state">
        <div class="no-results-content">
          <i class="fas fa-search"></i>
          <h3>لم يتم العثور على نتائج</h3>
          <p>جرب البحث بكلمات أخرى أو تغيير الفلاتر</p>
          <div class="suggestions">
            <p>اقتراحات للبحث:</p>
            <div class="suggestion-tags">
              <button 
                *ngFor="let suggestion of searchSuggestions" 
                (click)="searchSuggestion(suggestion)"
                class="suggestion-tag">
                {{ suggestion }}
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Products Grid/List -->
      <div *ngIf="searchResults.length > 0 && !loading" 
           class="products-container" 
           [class.grid-view]="viewMode === 'grid'"
           [class.list-view]="viewMode === 'list'">
        
        <!-- Grid View -->
        <div *ngIf="viewMode === 'grid'" class="products-grid">
          <div *ngFor="let product of searchResults" class="product-card">
            <div class="product-image">
              <img [src]="product.imageUrl" [alt]="product.name" (error)="onImageError($event)">
              
              <!-- Product Badges -->
              <div class="product-badges">
                <span *ngIf="product.prescription" class="badge prescription">
                  <i class="fas fa-prescription"></i>
                  Rx
                </span>
                <span *ngIf="product.stock < 10" class="badge low-stock">
                  <i class="fas fa-exclamation-triangle"></i>
                  كمية قليلة
                </span>
                <span *ngIf="product.stock === 0" class="badge out-of-stock">
                  <i class="fas fa-times"></i>
                  غير متوفر
                </span>
                <span class="badge seller" [class]="product.sellerType">
                  <i [class]="product.sellerType === 'rxclose' ? 'fas fa-star' : 'fas fa-store'"></i>
                  {{ product.sellerType === 'rxclose' ? 'RxClose' : 'صيدلية' }}
                </span>
              </div>
              
              <!-- Quick Actions -->
              <div class="product-overlay">
                <button (click)="viewProductDetails(product)" class="overlay-btn view-btn">
                  <i class="fas fa-eye"></i>
                </button>
                <button (click)="addToCart(product)" class="overlay-btn cart-btn" [disabled]="product.stock === 0">
                  <i class="fas fa-cart-plus"></i>
                </button>
              </div>
            </div>
            
            <div class="product-content">
              <h3 class="product-name" (click)="viewProductDetails(product)">{{ product.name }}</h3>
              <p class="product-description">{{ product.description }}</p>
              
              <!-- Pharmacy Info -->
              <div class="product-pharmacy" *ngIf="product.sellerName">
                <i class="fas fa-store"></i>
                <span class="pharmacy-name">{{ product.sellerName }}</span>
                <span *ngIf="product.distance" class="distance">
                  <i class="fas fa-map-marker-alt"></i>
                  {{ product.distance | number:'1.1-1' }}كم
                </span>
              </div>
              
              <!-- Price and Actions -->
              <div class="product-footer">
                <div class="product-price">
                  <span class="price">{{ product.price | currency:'EGP':'symbol':'1.2-2' }}</span>
                  <span class="stock" [class]="getStockClass(product.stock)">
                    <i [class]="getStockIcon(product.stock)"></i>
                    {{ getStockText(product.stock) }}
                  </span>
                </div>
                
                <div class="product-actions">
                  <button (click)="viewProductDetails(product)" class="btn btn-outline">
                    <i class="fas fa-info-circle"></i>
                    تفاصيل
                  </button>
                  <button 
                    (click)="addToCart(product)" 
                    class="btn btn-primary"
                    [disabled]="product.stock === 0">
                    <i class="fas fa-cart-plus"></i>
                    أضف للسلة
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- List View -->
        <div *ngIf="viewMode === 'list'" class="products-list">
          <div *ngFor="let product of searchResults" class="product-list-item">
            <div class="product-image">
              <img [src]="product.imageUrl" [alt]="product.name" (error)="onImageError($event)">
              <div class="product-badges">
                <span *ngIf="product.prescription" class="badge prescription">Rx</span>
                <span *ngIf="product.stock < 10" class="badge low-stock">قليل</span>
              </div>
            </div>
            
            <div class="product-details">
              <div class="product-header">
                <h3 class="product-name" (click)="viewProductDetails(product)">{{ product.name }}</h3>
                <div class="product-price">
                  <span class="price">{{ product.price | currency:'EGP':'symbol':'1.2-2' }}</span>
                </div>
              </div>
              
              <p class="product-description">{{ product.description }}</p>
              
              <div class="product-meta">
                <div class="product-pharmacy" *ngIf="product.sellerName">
                  <i class="fas fa-store"></i>
                  <span>{{ product.sellerName }}</span>
                  <span *ngIf="product.distance" class="distance">{{ product.distance | number:'1.1-1' }}كم</span>
                </div>
                
                <div class="product-stock">
                  <span [class]="getStockClass(product.stock)">
                    <i [class]="getStockIcon(product.stock)"></i>
                    {{ getStockText(product.stock) }}
                  </span>
                </div>
              </div>
              
              <div class="product-actions">
                <button (click)="viewProductDetails(product)" class="btn btn-outline btn-sm">
                  <i class="fas fa-info-circle"></i>
                  تفاصيل
                </button>
                <button 
                  (click)="addToCart(product)" 
                  class="btn btn-primary btn-sm"
                  [disabled]="product.stock === 0">
                  <i class="fas fa-cart-plus"></i>
                  أضف للسلة
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </section>

  <!-- Nearby Pharmacies Section -->
  <section class="pharmacies-section" *ngIf="nearbyPharmacies.length > 0 && !loading">
    <div class="container">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-map-marker-alt"></i>
          الصيدليات القريبة منك
        </h2>
        <p class="section-subtitle">{{ nearbyPharmacies.length }} صيدلية في المنطقة</p>
      </div>
      
      <div class="pharmacies-grid">
        <div *ngFor="let pharmacy of nearbyPharmacies" class="pharmacy-card">
          <div class="pharmacy-header">
            <div class="pharmacy-info">
              <h3 class="pharmacy-name">{{ pharmacy.name }}</h3>
              <p class="pharmacy-address">
                <i class="fas fa-map-marker-alt"></i>
                {{ pharmacy.address }}
              </p>
            </div>
            <div class="pharmacy-distance">
              <span class="distance">{{ pharmacy.distance | number:'1.1-1' }}كم</span>
            </div>
          </div>
          
          <div class="pharmacy-details">
            <div class="pharmacy-stats">
              <div class="stat">
                <i class="fas fa-pills"></i>
                <span>{{ pharmacy.productsCount }} منتج</span>
              </div>
              <div class="stat">
                <i class="fas fa-phone"></i>
                <span>{{ pharmacy.phone }}</span>
              </div>
            </div>
            
            <div class="pharmacy-actions">
              <button (click)="callPharmacy(pharmacy.phone)" class="btn btn-outline btn-sm">
                <i class="fas fa-phone"></i>
                اتصال
              </button>
              <button (click)="getDirections(pharmacy)" class="btn btn-primary btn-sm">
                <i class="fas fa-directions"></i>
                الطريق
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Chat Widget -->
  <app-chat-widget></app-chat-widget>

  <!-- Back to Top Button -->
  <button *ngIf="showBackToTop" (click)="scrollToTop()" class="back-to-top">
    <i class="fas fa-arrow-up"></i>
  </button>
</div>

<!-- Mobile Filters Overlay -->
<div *ngIf="showFilters" class="mobile-filters-overlay" (click)="toggleFilters()">
  <div class="mobile-filters-content" (click)="$event.stopPropagation()">
    <div class="mobile-filters-header">
      <h3>Filters</h3>
      <button (click)="toggleFilters()" class="close-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="mobile-filters-body">
      <!-- Same filter content as sidebar -->
    </div>
    <div class="mobile-filters-footer">
      <button (click)="resetFilters()" class="btn btn-outline">Reset</button>
      <button (click)="toggleFilters()" class="btn btn-primary">Apply Filters</button>
    </div>
  </div>
</div> 